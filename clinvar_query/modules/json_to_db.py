# json_to_db.py
from pathlib import Path
import json
from clinvar_query.utils.paths import database_file, clinvar_folder
from clinvar_query.modules.insert_annotated_results import insert_clinvar, insert_patient_information, insert_variants

def json_to_dir():
    # Directory containing JSON files generated by clinvar_api_query
    json_dir = Path(clinvar_folder)
    json_files = list(json_dir.glob("*.json"))
    

    if not json_files:
        print(f"⚠️ No JSON files found in {json_dir}")
    else:
        print(f"Found {len(json_files)} JSON files in {json_dir}")

    for json_file in json_files:
        print(f"Processing file: {json_file.name}")
        try:
            with open(json_file, "r") as f:
                variants_data = json.load(f)
                p_id = Path(json_file).stem
                patient_id = p_id.split("_")[0]
        except Exception as e:
            print(f"❌ Failed to load {json_file}: {e}")
            continue

        for entry in variants_data:
            variant_str = entry.get("variant")
            g_hgvs = entry.get("g_hgvs")
            summary = entry.get("esummary", {})

            if not variant_str or not g_hgvs or not summary:
                print(f"⚠️ Skipping malformed entry: {entry}")
                continue

#amended extraction of clinvar JSON files

            # --- Resolve ClinVar record ---
            uids = summary.get("uids", [])
            if not uids:
                print(f"⚠️ No ClinVar UID found for variant {variant_str}")
                continue

            cv_id = uids[0]
            cv_data = summary.get(cv_id, {})

            # --- Gene symbol ---
            gene = None
            genes = cv_data.get("genes", [])
            if genes:
                gene = genes[0].get("symbol")

            # --- Chromosome (current assembly) ---
            chromosome = None
            variation_set = cv_data.get("variation_set", [])
            if variation_set:
                locs = variation_set[0].get("variation_loc", [])
                for loc in locs:
                    if loc.get("status") == "current":
                        chromosome = loc.get("chr")
                        break

            # --- Germline classification & review status ---
            germline = cv_data.get("germline_classification", {})
            classification = germline.get("description")
            star_rating = germline.get("review_status")

            # --- Associated conditions ---
            conditions = []
            for trait in germline.get("trait_set", []):
                name = trait.get("trait_name")
                if name:
                    conditions.append(name)

            associated_conditions = "; ".join(conditions) if conditions else None

            # --- Allele frequency ---
            allele_frequency = None
            if variation_set:
                freq_set = variation_set[0].get("allele_freq_set", [])
                if freq_set:
                    allele_frequency = freq_set[0].get("value")

            # --- Prepare DB payloads ---
            clinvar = {
                "variant_id": variant_str,
                "consensus_classification": classification,
                "hgvs": g_hgvs,
                "associated_conditions": associated_conditions,
                "gene": gene,
                "star_rating": star_rating,
                "allele_frequency": allele_frequency,
                "chromosome": chromosome
            }

            patient_info = {
                "patient_id": patient_id,
                "id_test_type": p_id
            }

            variants = {
                "variant_id": variant_str,
                "id_test_type": p_id,
                "patient_variant": f"{p_id}_{variant_str}"
            }

            insert_patient_information(patient_info)
            insert_variants(variants)
            insert_clinvar(clinvar)

    print("✅ All ClinVar JSON files processed into the database.")


if __name__ == "__main__":
    json_to_dir()